<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eventos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="Estilos/Eventos.css">
</head>
<body>
    <header>
        <div id="titulo">
            <h2>Eventos disponibles</h2>
        </div>
            <div id="sessiones-listado">
        </div>
     </header>

    
 
     <section>
        <div id="eventos-container"></div>
    </section>

    <script>
        function convertirFechaAFormatoDMY(fecha) {
            var partes = fecha.split("-");
            if (partes.length === 3) {
                var anio = partes[0];
                var mes = partes[1];
                var dia = partes[2];
                return dia + "/" + mes + "/" + anio;
            }
            return fecha;
        }
    
        // Hacer una solicitud AJAX para obtener los datos de la tabla eventos
        fetch('../Controllers/eventosControlador.php?consultarEventos=true')
            .then(response => response.json())
            .then(data => {
                // Iterar sobre los datos y generar divs para cada evento
                const eventosContainer = document.getElementById('eventos-container');
                data.forEach(evento => {
                    const divEvento = document.createElement('div');
                    divEvento.className = 'evento';
                    divEvento.innerHTML = `
                        <h2>${evento.titulo}</h2>
                        <p>${evento.descripcion}</p>
                        <p>Fecha de Inicio: ${convertirFechaAFormatoDMY(evento.fecha_inicio)}</p>
                        <p>Fecha de Finalizacion: ${convertirFechaAFormatoDMY(evento.fecha_fin)}</p>
    
                        <img src="${evento.img}" alt="Imagen del evento" class="img">
                        `;

                        const fechaActual = new Date();
                        const fechaInicioEvento = new Date(evento.fecha_inicio); // Supongo que "evento.fecha_fin" es la fecha de finalización del evento
                        const fechaFinEvento = new Date(evento.fecha_fin);

                        let botonAInsertar;

                        if (fechaActual > fechaInicioEvento && fechaActual<fechaFinEvento) {
                            divEvento.innerHTML += `
                                <br><br>
                                <button type="button" class="btn btn-outline-info reservar-btn" data-pk-eventos="${evento.pk_eventos}" >Reservar</button>
                                `;                        
                        } else {
                            divEvento.innerHTML += `<br><br><button type="button" class="btn btn-outline-secondary reservar-btn" data-pk-eventos="${evento.pk_eventos}" >Reservar</button>
                            `;     
                        }


                    eventosContainer.appendChild(divEvento);
    
                    // Agregar un controlador de eventos al botón "Reservar"
                    const reservarBtn = divEvento.querySelector('.reservar-btn');
                    reservarBtn.addEventListener('click', function() {
                        // Obtener el valor de data-pk-eventos del botón
                        const pkEventos = this.getAttribute('data-pk-eventos');
    
                        // Ahora puedes utilizar pkEventos en tu aplicación, por ejemplo, enviarlo al servidor o realizar alguna otra acción específica
                        console.log('pk_eventos al hacer clic en Reservar:', pkEventos);
                        
                        if (fechaActual > fechaInicioEvento && fechaActual<fechaFinEvento) {
                            VerificarOrden(pkEventos);                      
                        } else {
                            alert("No disponible para compras."); 
                        }
                        
                    });
                });
            })
            .catch(error => {
                console.error('Error al obtener los datos de eventos:', error);
            });

            const sessionesContainer = document.getElementById("sessiones-listado")

            fetch('../Controllers/sessionesController.php')
            .then(response => response.json())
            .then(data => {
                // Verifica que data sea un array
 
                // Verifica que la propiedad "sessiones" exista en el objeto
                if (Array.isArray(data)) {
                const divSessiones = document.createElement('div');
                divSessiones.className = 'divSessiones';
                divSessiones.innerHTML = `
                    <h6>Cantidad de usuarios en session: ${data.length}</h6>
                `;
                sessionesContainer.appendChild(divSessiones);
                }
                            
            })
            .catch(error => {
                console.error('Error al obtener los usuarios en espera:', error);
            });

           

            
            window.addEventListener("beforeunload", function (e) {
                console.log("Evento beforeunload disparado"); // Agrega un mensaje de depuración en la consola

                enviarSolicitudPOSTParaCerrarSesion();
            });
       

            function enviarSolicitudPOSTParaCerrarSesion() {
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "../Controllers/eventosControlador.php", true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === 4 && xhr.status === 200) {
                        // La solicitud POST se ha completado con éxito
                        // Puedes mostrar un mensaje o realizar otras acciones aquí
                    }
                };
                xhr.send("activo=no");
            }


        
        //    Obtén el estado de sesión del servidor y configúralo en estadoSession
 
        function enviarHeartbeat() {
                fetch("../Controllers/eventosControlador.php?ESTADOSESSION=ESTADO")
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Error en la solicitud AJAX");
                        }
                        return response.text();

                    })
                    .catch(error => {
                        // Maneja errores en la solicitud AJAX
                        console.error("Error en la solicitud AJAX:", error);
                    });
            }

        setInterval(enviarHeartbeat, 1000); // por seg

 
        function VerificarOrden(pkEventos) {
            fetch("../Controllers/eventosControlador.php?VerificarOrden=true")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Error en la solicitud AJAX");
                    }
                    return response.text();
                })
                .then(data => {
                    data = data.trim(); // Elimina espacios en blanco y caracteres no deseados
                    if (data === "true") {
                        window.location.href = `reservar.php?pk_eventos=${pkEventos}`;
                    } else {
                        alert("Debe esperar en la fila para reservar la entrada");
                    }
                })
                .catch(error => {
                    // Maneja errores en la solicitud AJAX
                    console.error("Error en la solicitud AJAX:", error);
                });
        }



    </script>
    
</body>
</html>